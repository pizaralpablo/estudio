apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      # Prometheus se auto-scrapea
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      # ----------------------------
      # Kubernetes (básico de ejemplo)
      # ----------------------------
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics

      - job_name: 'kubernetes-pods-annotated'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: "true"
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2

      # ----------------------------
      # ISTIO: Envoy sidecars en TODOS los pods
      # ----------------------------
      - job_name: 'istio-envoy'
        kubernetes_sd_configs:
          - role: pod
        metrics_path: /stats/prometheus
        relabel_configs:
          # Mantén solo los pods que tienen el contenedor "istio-proxy"
          - source_labels: [__meta_kubernetes_pod_container_name]
            regex: istio-proxy
            action: keep
          # Usa el puerto 15090 (admin de Envoy) de los sidecars
          - source_labels: [__address__]
            target_label: __address__
            regex: ([^:]+)(?::\d+)?
            replacement: $1:15090
          # Etiquetas útiles
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

      # ----------------------------
      # ISTIO: istiod
      # ----------------------------
      - job_name: 'istiod'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            regex: istio-system
            action: keep
          - source_labels: [__meta_kubernetes_service_name]
            regex: istiod
            action: keep
        metrics_path: /metrics
        scheme: http
        # istiod expone métricas en 15014
        relabel_configs:
          - source_labels: [__address__]
            target_label: __address__
            regex: ([^:]+):\d+
            replacement: $1:15014

      # ----------------------------
      # ISTIO: Ingress Gateway (opcional)
      # ----------------------------
      - job_name: 'istio-ingressgateway'
        kubernetes_sd_configs:
          - role: endpoints
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            regex: istio-system
            action: keep
          - source_labels: [__meta_kubernetes_service_name]
            regex: istio-ingressgateway
            action: keep
        metrics_path: /stats/prometheus
        scheme: http
        # usa puerto 15090
        relabel_configs:
          - source_labels: [__address__]
            target_label: __address__
            regex: ([^:]+):\d+
            replacement: $1:15090
